<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>blockly</title>
    <style>
        /* body {
            width: 100%;
            height: 100%;
            border: 1px solid #ccc;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        } */
        .cursor {
            border-radius: 50%;
            background: blue;
            width: 10px;
            height: 10px;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100
        }
    </style>
    <script src="https://code.jquery.com/jquery-1.8.3.js"></script>
    <script>
        jQuery.fn.getPath = function () {
            // stolen from http://stackoverflow.com/a/2068381/1376627
            if (this.length != 1) throw 'Requires one element.';
            var path, node = this;
            // console.log('this----', this);
            while (node.length) {
                var realNode = node[0], name = realNode.localName;
                if (!name) break;
                name = name.toLowerCase();

                var parent = node.parent();

                var siblings = parent.children(name);
                if (siblings.length > 1) {
                    name += ':eq(' + siblings.index(realNode) + ')';
                }

                path = name + (path ? '>' + path : '');
                node = parent;
            }

            return path.split('html>')[1];
        };
        
        var workspace = null;
        var blocklyEvents = [];
        window.onload = function () {
            workspace = Blockly.inject('blocklyDiv', {
                toolbox: document.getElementById('toolbox'),
                collapse: true,
                disable: true,
                comments: true,
                // maxBlocks: 3,
                // readOnly: true,
                // trashcan: true
            });
                
            // workspace.addChangeListener(eventListener);
        }
        function addBlocklyEventListener() {
            console.log('开始blockly事件录制');
            if (workspace) {
                workspace.addChangeListener(addEvents)
            }
        }

        function removeBlocklyEventListener(callback) {
            console.log('解除blockly事件录制');
            if (workspace) {
                workspace.removeChangeListener(addEvents);
                callback && callback(blocklyEvents);
                blocklyEvents = [];
            }
        }

        function addEvents(event) {
            // if (event.type != Blockly.Events.UI) {
                event.time = Date.now();
                console.log('blocklyEvent--type', event.type);
                console.log('blocklyEvent', event);
                blocklyEvents.push(event);
                // var code = Blockly.JavaScript.workspaceToCode(workspace)
                // document.getElementById('textarea').value = code;
            // }
        }

        function runBlocklyEvent(eventJson) {
            var event = Blockly.Events.fromJson(eventJson, workspace);
            event.run(true);
        }

        function clear() {
            workspace.clear();
        }
    </script>
</head>
<body>
    <!-- <h1>测试</h1> -->
    <div id="blocklyDiv" style="height: 700px; width: 800px"></div>
    <xml id="toolbox" style="display: none">
        <category name="controls">
            <block type="controls_if"></block>
            <block type="controls_ifelse"></block>
            <block type="controls_if_if"></block>
            <block type="controls_if_elseif"></block>
            <block type="controls_if_else"></block>
            <block type="controls_repeat_ext"></block>
            <block type="controls_repeat"></block>
            <block type="controls_whileUntil"></block>
            <block type="controls_for"></block>
            <block type="controls_forEach"></block>
            <block type="controls_flow_statements"></block>
        </category>
        <category name="logic">
            <block type="logic_compare"></block>
            <block type="logic_boolean"></block>
            <block type="logic_operation"></block>
            <block type="logic_negate"></block>
            <block type="logic_null"></block>
            <block type="logic_ternary"></block>
        </category>
        <category colour="210" name="math">
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
            <block type="math_single"></block>
            <block type="math_trig"></block>
            <block type="math_constant"></block>
            <block type="math_number_property"></block>
            <block type="math_change"></block>
            <block type="math_round"></block>
            <block type="math_on_list"></block>
            <block type="math_modulo"></block>
            <block type="math_constrain"></block>
            <block type="math_random_int"></block>
            <block type="math_random_float"></block>
            <block type="math_atan2"></block>
        </category>
        <category name="text">
            <block type="text"></block>
            <block type="text_print"></block>
            <block type="text_join"></block>
            <block type="text_create_join_container"></block>
            <block type="text_create_join_item"></block>
            <block type="text_append"></block>
            <block type="text_length"></block>
            <block type="text_isEmpty"></block>
            <block type="text_indexOf"></block>
            <block type="text_charAt"></block>
        </category>
        
    </xml>
    <textarea id="textarea" style="display:none"></textarea>
    <!-- <script src="./lib/blockly_compressed.js"></script>
    <script src="./lib/blocks_compressed.js"></script> -->
    <script src="./lib/blockly_compressed_2.js"></script>
    <script src="./lib/blocks_compressed_2.js"></script>
    <script src="./lib/javascript_compressed.js"></script>
    <script src="./lib/en.js"></script>
</body>
</html>